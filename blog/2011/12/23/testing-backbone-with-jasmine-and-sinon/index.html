

<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Testing Backbone with Jasmine &amp; Sinon - Tom Philip - Full Stack, Rails, .NET, Android and Boxee Developer</title>
  <meta name="author" content="Tom Philip">

  
  <meta name="description" content="Dec 23rd, 2011 Tom Philip BDD, Backbone Testing Backbone with Jasmine &amp; Sinon This is based on an XKCD leanback web app I&#8217;m working on &hellip;">
  

  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tommysqueak.github.io/blog/2011/12/23/testing-backbone-with-jasmine-and-sinon">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Tom Philip - Full Stack, Rails, .NET, Android and Boxee Developer" type="application/atom+xml">
  <script src="/javascripts/vendor/modernizr-2.0.js"></script>
</head>

<body class="page-post">

  <header class="site-header" role="banner"><div class="site-header__back" data-200-start="opacity[quadratic]:0.5" data-400-start="opacity[quadratic]:1"></div>
<div class="site-header__footer" data-400-start="left[cubic]:100%" data-500-start="left[cubic]:0%"></div>

<nav class="navbar navbar-fixed-top navbar-inverse" role="navigation" data-500-start="border-bottom-width[quadratic]:0px" data-540-start="border-bottom-width[quadratic]:4px">

  <div class="navbar-header">
    
    <button id="navToggler" type="button" aria-label="Toggle navigation" class="lines-button x2 navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
      <span class="lines"></span>
    </button>

    <div class="site-header__identity navbar-brand">
      <a href="/"><img class="avatar site-header__avatar" src="/images/tomphilip_thumbnail.jpg" alt="Tom Philip" data-start="height[quadratic]:100px" data-480-start="height[quadratic]:44px"></a>
      <h1 class="site-header__title"><a href="/">Tom Philip</a></h1>
    </div>
  </div>

  <div class="collapse navbar-collapse">
<ul class="site-navigation site-navigation--header nav navbar-nav navbar-right">
  <li class="site-navigation__link"><a href="/about.html" title="About Tom Philip">About</a></li>
  <li class="site-navigation__link"><a href="/interests.html" title="Things that interest Tom Philip">Interest</a></li>
  <li class="site-navigation__link"><a href="/contact.html" title="Contact Tom Philip">Contact</a></li>
  <li class="site-navigation__link"><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><span class="icon-rss"></span></a></li>
</ul></div>
  
</nav>


</header>

  <div id="skrollr-body1" class="site-container">
     <div class="container">

  <div class="row">
    <div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2">
      <article class="post" role="article">
        
  <header class="post__header">

    
      <p class="post-metadata">
        











<time class="post__published" datetime="2011-12-23T00:00:00+01:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2011</time>
        
  

<span class="post-metadata__author"><span>Tom Philip</span></span>

        

<span class="post-metadata__categories">
  
    <a class='category' href='/blog/categories/bdd/'>BDD</a>, <a class='category' href='/blog/categories/backbone/'>Backbone</a>
  
</span>


        
      </p>
    

    <h1 class="post__title">Testing Backbone with Jasmine &amp; Sinon</h1>

  </header>




<div class="post__content">This is based on an <strong><a href="http://xkcd.com">XKCD</a> leanback web app</strong> I&#8217;m working on that will form part of a html5 <a title="Boxee app developer" href="http://www.greatboxee.com">Boxee app</a>. Think sitting on your couch, remote control in hand flicking through XKCD comics on the TV.

It brings together quite a few technologies and techniques. The end results is something that is separated out nicely (no spaghetti code) that is simple, testable, documented and maintainable.

<!--more-->

<h2>The Specs</h2>
[codesyntax lang=&#8221;javascript&#8221; tab_width=&#8221;1&#8221;]
<pre>describe("Comic Navigator", function(){

  var nav = new Xkcd.ComicNavigator();
  var latestComic = new Xkcd.Comic({id: 101});

  describe("when navigating to the latest xkcd comic", function(){

    beforeEach(function(){
      this.fetchStub = sinon.stub(Xkcd.Comic.prototype, 'fetch').yieldsTo('success', latestComic);

      nav.toLatest();
    });

    afterEach(function(){
      this.fetchStub.restore();
    });

    it("should fetch the latest comic. NB requests without a comic number get the latest comic.", function(){
      expect(this.fetchStub.thisValues[0].get("id")).toBeFalsy();
    });

    it("should navigate to the latest comic", function(){
      expect(nav.get("current")).toBe(latestComic);
    });

    it("should keep track of what the latest comic is", function(){
      expect(nav.get("latest")).toBe(latestComic);
    });
  });
});</pre>
[/codesyntax]

<h3>So what&#8217;s going on?</h3>
<strong><a title="Jasmine BDD Framework for Javascript" href="http://pivotal.github.com/jasmine/">Jasmine</a> is the BDD framework</strong> that is giving us that familiar &#8216;describe/it&#8217; way of defining the behaviour and at the code level the expect-ations. It&#8217;s easy to understand and get started with. It doesn&#8217;t have to be run in the browser as it has no dependency on the DOM, so is CI friendly too.

<strong><a title="Mocking, stubbing, spying framework for Javascript" href="http://sinonjs.org/">Sinon.JS</a> is the mocking framework</strong>. It&#8217;s only being used here to stub out the fetch call, which would otherwise make a call to the server. It  also keeps the call synchronous and gives us a canned answer that we can later observe. It&#8217;s framework independent, so can be used with your favourite Javascript testing framework.
<h2>The Feature</h2>
[codesyntax lang=&#8221;javascript&#8221; tab_width=&#8221;1&#8221;]
<pre>var Xkcd = (function(){

  var ComicNavigator = Backbone.Model.extend({

      toLatest: function(){
        var comic = new Comic()
        var nav = this;
        comic.fetch({
          success: function(model){
            nav.set({"current": model});
            nav.set({"latest": model});
          }
        });
      }
    }
  );

  var Comic = Backbone.Model.extend({
    url: function(){
      return 'http://dynamic.xkcd.com/api-0/jsonp/comic/' + (this.id || "") + '?callback=?'
    },

    initialize: function(){
        this.backbone_fetch = this.fetch;
      this.fetch = function(options)
      {
        options || (options = {});
        options.jsonpCallback = 'comicIncoming';
        return this.backbone_fetch(options);
      }
    }
  });

  return {
    ComicNavigator: ComicNavigator,
    Comic: Comic
  };

})();</pre>
[/codesyntax]
<h3>So what&#8217;s going on?</h3>
First of all, I&#8217;m using the <strong><a href="http://www.addyosmani.com/resources/essentialjsdesignpatterns/book/#revealingmodulepatternjavascript">Revealing Module Pattern</a> to namespace the models</strong> into &#8216;Xkcd&#8217;. The return statement at the end is effectively publicly exposing the ComicNavigator and Comic. Anything I want to keep private I can, I just don&#8217;t expose it. This particular version of the <a href="http://www.addyosmani.com/resources/essentialjsdesignpatterns/book/#modulepatternjavascript">Module Pattern</a> is quite neat as it clearly shows what&#8217;s public and you can use consistent function definitions regardless of whether the function is public or private.

<strong><a title="Backbone" href="http://documentcloud.github.com/backbone/">Backbone.js</a> is a lightweight MVC-like framework</strong> that allows you to structure your code, specifically separating your data from its presentation. I&#8217;m doing it an injustice, it actually does a lot more and is very useful in keeping everything in sync with a RESTful backend, not to mention routing, eventing and validation.

In the above example I have 2 models. The rest of the code uses <a title="Backbone Router" href="http://documentcloud.github.com/backbone/#Router">routes</a> for bookmarking specific comics and possibly navigation to (I&#8217;ve yet to decide on that). There&#8217;s also a <a title="Backbone View" href="http://documentcloud.github.com/backbone/#View">view</a> which will bind to the current comic on the navigator. As the navigator changes the current comic the UI will automatically reflect this. You&#8217;ll be able to see all this in the finished app (coming soon!).

For the Comic model, Backbone has a <a title="Backbone Model fetch method" href="http://documentcloud.github.com/backbone/#Model-fetch">fetch</a> method that will automatically populate the model, given a url. I&#8217;m overriding the url property in order to add a <a href="http://en.wikipedia.org/wiki/JSONP">jsonp</a> callback (the XKCD service is on a different domain to the app). <strong>Just by adding &#8220;?callback=?&#8221; means backbone will switch to jsonp</strong>. Backbone just defers to jQuery&#8217;s $.ajax (or <a title="Zepto.JS" href="http://zeptojs.com/">Zeptos</a>) method, which automatically detects the  presence of =? and switches from json to jsonp. If there&#8217;s no comic id the service returns the latest comic. I&#8217;m also intercepting the fetch function to specify &#8216;comicIncoming&#8217; as the callback, normally this isn&#8217;t necessary but the XKCD service doesn&#8217;t like jQuerys automatically generated callback.

At this stage, I&#8217;m not certain that the Navigator should be a Backbone model. It makes sense in a typical MVC app and has some characteristics of a Backbone model but then doesn&#8217;t have the persistence/entity behaviours.

I&#8217;m also not happy with the 1st spec, I think it&#8217;s highlighting a smell around newing up a comic. My static mind says inject a factory but that doesn&#8217;t feel right in a dynamic language. Thoughts?

What I&#8217;ve shown is a small slice of the app, to show off some of the techniques and tools. Clearly there&#8217;s more, I just haven&#8217;t written it yet. Once the app is complete, it will show how the other parts come into play, specifically the routes and the view.
<h2>To Recap</h2>
<ul>
  <li><a href="http://www.addyosmani.com/resources/essentialjsdesignpatterns/book/#modulepatternjavascript">Module Pattern</a> for namespacing and keeping things private</li>
  <li><a href="http://pivotal.github.com/jasmine/">Jasmine</a> for BDD style testing ala RSpec</li>
  <li><a href="http://sinonjs.org/">Sinon</a> for test doubles (mocks, stubs etc if you care about the terms which cause more confusion than their worth)</li>
  <li><a href="http://documentcloud.github.com/backbone/">Backbone</a> for separating code into different concerns</li>
  <li><a href="http://en.wikipedia.org/wiki/JSONP">Jsonp</a> with Backbone to fetch data from a different domain</li>
</ul>
<strong>Update:</strong> The finished <a title="Introducing XKCD Couch" href="http://tomphilip.me/index.php/introducing-xkcd-couch/">xckd couch app</a>, the <a href="http://www.greatboxee.com/index.php/2012/01/30/xkcd-app-reborn/">html5 boxee app</a> and the <a title="Backbone on the Couch" href="http://tomphilip.me/index.php/backbone-on-the-couch/">backbone on the couch plugin</a> that came out of all of it.

&nbsp;
</div>


        <footer class="post__footer">
          
            <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://tommysqueak.github.io/blog/2011/12/23/testing-backbone-with-jasmine-and-sinon/" data-via="tommysqueak" data-counturl="http://tommysqueak.github.io/blog/2011/12/23/testing-backbone-with-jasmine-and-sinon/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

          
          <ul class="pager post__navigation">
            
              <li><a class="basic-alignment left" href="/blog/2011/11/21/gtd-app-review-producteev/" title="Previous Post: GTD App Review - Producteev">&laquo; GTD App Review - Producteev</a></li>
            
            
              <li><a class="basic-alignment right" href="/blog/2013/10/13/a-test-post-so-we-can-design-the-home-page/" title="Next Post: A test post so we can design the home page">A test post so we can design the home page &raquo;</a></li>
            
          </ul>
        </footer>
      </article>
      
    </div>
  </div>
  
</div>

  </div>

  <footer role="contentinfo" class="site-footer">

<div class="container">

  <p class="footnote footnote--credit">
    Designed &amp; made by Tom Philip, powered by <a href="http://octopress.org">octopress</a>
  </p>

  <p class="footnote footnote--copyright">
    Copyright &copy; 2013 Tom Philip
  </p>

  <div class="row">
    <div class="col-md-4">

      <section class="list list--icons">
        <h1 class="list__title">Social</h1>
        <ul class="list__list">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS"><span class="icon-rss"></span></a></li>
          <li><a href="http://twitter.com/tommysqueak" rel="nofollow" title="Twitter"><span class="icon-twitter-3"></span></a></li>
          <li><a href="http://www.facebook.com/tommysqueak" rel="nofollow" title="Facebook"><span class="icon-facebook"></span></a></li>
          <li><a href="https://plus.google.com/114913251697222576781?rel=author" rel="publisher" title="Google+"><span class="icon-google__x2B_"></span></a></li>
          <li><a href="http://www.linkedin.com/in/tomphilip" rel="nofollow" title="LinkedIn"><span class="icon-linkedin"></span></a></li>
          <li><a href="http://www.flickr.com/photos/tommysqueak/" rel="nofollow" title="Flickr"><span class="icon-flickr"></span></a></li>
          <li><a href="http://pinterest.com/tommysqueak/" rel="nofollow" title="PInterest"><span class="icon-pinterest"></span></a></li>
          <li><a href="http://www.youtube.com/user/MrTommysqueak" rel="nofollow" title="YouTube"><span class="icon-youtube"></span></a></li>
          <li><a href="http://realworldusability.tumblr.com/" rel="nofollow" title="Tumblr"><span class="icon-tumblr"></span></a></li>
          <li><a href="http://vimeo.com/greatboxee" rel="nofollow" class="icon-vimeo" title="Vimeo"></a></li>
          <li><a href="http://foursquare.com/tommysqueak" rel="nofollow" title="FourSquare"><span class="icon-foursquare_1"></span></a></li>
          <li><a href="https://github.com/tommysqueak" rel="nofollow" title="GitHub"><span class="icon-github-01"></span></a></li>
          <li><a href="http://open.spotify.com/user/tommysqueak" rel="nofollow" title="Spotify"><span class="icon-spotify"></span></a></li>
          <li><a href="http://instagram.com/tommysqueak" rel="nofollow" title="Instagram"><span class="icon-instagram"></span></a></li>
          <li><a href="http://about.me/tomphilip" rel="nofollow" title="about.me">me</a></li>
        </ul>
      </section>

    </div>
    
    <div class="col-md-4">
      

      
    </div>
    <div class="col-md-4">
      <section class="list recent-posts">
  <h1 class="list__title">Recent Posts</h1>
  <ul class="list__list">
    
      <li>
        <a href="/blog/2013/10/13/a-test-post-so-we-can-design-the-home-page/">A test post so we can design the home page</a>
      </li>
    
      <li>
        <a href="/blog/2011/12/23/testing-backbone-with-jasmine-and-sinon/">Testing Backbone with Jasmine &amp; Sinon</a>
      </li>
    
      <li>
        <a href="/blog/2011/11/21/gtd-app-review-producteev/">GTD App Review - Producteev</a>
      </li>
    
      <li>
        <a href="/blog/2011/11/07/gtd-app-review-astrid/">GTD App Review - Astrid</a>
      </li>
    
      <li>
        <a href="/blog/2011/10/25/gtd-app-review-wunderlist/">GTD App Review - Wunderlist</a>
      </li>
    
    <li><a href="/blog/archives">More...</a></li>
  </ul>
</section>

    </div>

  </div>

</div>


</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/javascripts/vendor/jquery.min.js"><\/script>')</script>

<script type="text/javascript" src="/javascripts/vendor/bootstrap.transition.js"></script>
<script type="text/javascript" src="/javascripts/vendor/bootstrap.collapse.js"></script>
<script type="text/javascript" src="/javascripts/vendor/skrollr.min.js"></script>
<script type="text/javascript" src="/javascripts/vendor/jquery.simple-text-rotator.min.js"></script>
<script type="text/javascript" src="/javascripts/vendor/jquery.simple-text-rotator.min.js"></script>
<!--[if lt IE 8]><script src="/javascripts/vendor/pictonic.min.js"></script><![endif]-->

<!--[if lt IE 9]>
<script type="text/javascript" src="/javascripts/vendor/skrollr.ie.min.js"></script>
<![endif]-->
<script type="text/javascript">
  nav = $('.page-post .navbar').removeAttr('data-500-start data-540-start');
  $('.page-post .site-header__footer').removeAttr('data-400-start data-500-start');

  //nav.attr('data-10-start', 'background-color[quadratic]:rgb(255, 255, 255)');
  //nav.attr('data-50-start', 'background-color[quadratic]:rgb(34, 34, 34)');
  
  $('.navbar-collapse').on('show.bs.collapse', function() {
    $('#navToggler').addClass('opened');
  });
  
  $('.navbar-collapse').on('hide.bs.collapse', function() {
    $('#navToggler').removeClass('opened');
  });
</script>

<script type="text/javascript">
  var s = skrollr.init({forceHeight: false});
</script>

<script type="text/javascript">
	$(".rotate").textrotator({
	  animation: "flip",
		separator: ",", 
	  speed: 2000
	});
</script>




</body>
</html>
